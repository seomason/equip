<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>장비 태그 데모 (Sheets 연동)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; margin: 18px; background:#fafafa; }
    .box { max-width: 560px; background:#fff; border:1px solid #e7e7e7; border-radius: 14px; padding: 16px; box-shadow:0 6px 22px rgba(0,0,0,0.05);}
    h2 { margin:0 0 6px; }
    .muted { color:#777; font-size: 12px; }
    .kv { margin:10px 0; padding:10px; border:1px solid #eee; border-radius: 12px; background:#fcfcfc; }
    .k { font-size:12px; color:#666; }
    .v { font-weight:700; margin-top:4px; }
    label { display:block; margin-top:10px; font-size:13px; color:#444; }
    input, select { width:100%; padding:10px; border-radius: 12px; border:1px solid #d8d8d8; }
    button { width:100%; margin-top:12px; padding:12px; border:0; border-radius:12px; background:#111; color:#fff; font-weight:800; cursor:pointer; }
    .msg { margin-top:10px; font-size:13px; }
    .ok { color:#0a7; }
    .err { color:#c33; }
    code { background:#f1f1f1; padding:2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="box">
    <h2>장비 조회/수정 (Sheets 연동)</h2>
    <div class="muted">
      URL에 <code>?id=BLS-06-0001</code> 처럼 붙이면 해당 장비를 불러옵니다. (NFC 태그 URL도 이 방식)
    </div>

    <div id="msg" class="msg muted"></div>

    <div class="kv">
      <div class="k">장비코드</div>
      <div class="v" id="idText">-</div>
    </div>
    <div class="kv">
      <div class="k">장비명</div>
      <div class="v" id="nameText">-</div>
    </div>
    <div class="kv">
      <div class="k">시리얼</div>
      <div class="v" id="serialText">-</div>
    </div>

    <label>상태</label>
    <select id="status">
      <option value="OK">OK</option>
      <option value="REPAIR">REPAIR</option>
      <option value="OUT">OUT</option>
      <option value="LOST">LOST</option>
    </select>

    <label>위치</label>
    <input id="location" placeholder="예: R&D Lab / 창고A / 현장" />

    <label>담당자</label>
    <input id="owner" placeholder="예: 서중근" />

    <label>기록자(로그용)</label>
    <input id="user" placeholder="예: 서중근" />

    <button id="saveBtn">저장 (시트 반영)</button>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbybWwU7jxyQt-76H9i-5SbXQiAeNmIoWxNk_z5Y1OCOkyXWiS852JK7Px5EUvZw6IJngQ/exec";

  const el = (id) => document.getElementById(id);
  const setMsg = (text, cls="muted") => {
    el("msg").className = "msg " + cls;
    el("msg").textContent = text;
  };

  const qs = new URLSearchParams(location.search);
  const equipId = (qs.get("id") || "").trim();

  // ✅ JSONP helper
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);

      const script = document.createElement("script");
      const cleanup = () => {
        try { delete window[cb]; } catch {}
        if (script && script.parentNode) script.parentNode.removeChild(script);
      };

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      script.async = true;
      script.onerror = () => {
        cleanup();
        reject(new Error("JSONP load failed"));
      };

      document.head.appendChild(script);
    });
  }

  async function load() {
    if (!equipId) {
      setMsg("URL에 ?id= 가 없습니다. 예: ?id=BLS-06-0001", "err");
      return;
    }
    el("idText").textContent = equipId;
    setMsg("불러오는 중...");

    try {
      const json = await jsonp(`${API_URL}?id=${encodeURIComponent(equipId)}`);

      if (!json || !json.ok) {
        setMsg("조회 실패: " + (json?.error || "unknown"), "err");
        return;
      }

      const d = json.data || {};
      el("nameText").textContent = d.name ?? "-";
      el("serialText").textContent = d.serial ?? "-";
      el("status").value = d.status || "OK";
      el("location").value = d.location || "";
      el("owner").value = d.owner || "";

      setMsg("로드 완료 ✅", "ok");
    } catch (e) {
      setMsg("조회 중 오류: " + e.message, "err");
    }
  }

  // 일단 느낌 확인을 위해 저장 버튼은 막아둠 (CORS 때문에 POST는 다음 단계에서 운영형으로 처리)
  el("saveBtn").addEventListener("click", () => {
    setMsg("저장은 다음 단계에서 (운영형 구조로) 연결할게요. 지금은 조회 느낌 확인!", "muted");
  });

  load();
</script>

</body>
</html>





